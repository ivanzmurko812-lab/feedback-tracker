<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feedback Tracker</title>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#cfd6e6;
      --bg2:#eef2ff;

      --card: rgba(255,255,255,.82);
      --card2: rgba(255,255,255,.62);
      --stroke: rgba(190,200,220,.85);

      --text:#101526;
      --muted:#5e6a84;

      --blue1:#2f6cf6;
      --blue2:#1e4fd3;

      --danger:#d6363a;

      --shadow: 0 26px 70px rgba(12,18,40,.18);
      --shadow2: 0 14px 30px rgba(12,18,40,.14);

      --r1: 22px;
      --r2: 16px;

      --focus: 0 0 0 4px rgba(47,108,246,.22);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      overflow-x:hidden;

      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(255,255,255,.95) 0%, rgba(255,255,255,0) 55%),
        radial-gradient(900px 600px at 90% 0%, rgba(255,255,255,.90) 0%, rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    .hidden{ display:none !important; }
    a{ color:var(--blue1); text-decoration:none; }

    /* ===== Topbar ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      padding: 14px 18px;
      background:
        linear-gradient(180deg, rgba(28,40,80,.45), rgba(28,40,80,.18));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,.35);
    }
    .topbar-inner{
      max-width: 1800px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{
      flex:1;
      text-align:center;
      color:#fff;
      font-weight: 900;
      font-size: 34px;
      letter-spacing:.3px;
      text-shadow: 0 12px 26px rgba(0,0,0,.25);
    }
    .actions{
      width: 360px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap: 12px;
      color:#eef2ff;
      font-weight:800;
      white-space:nowrap;
    }
    .pill{
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 10px 24px rgba(0,0,0,.12);
      font-size: 14px;
    }
    .linklike{
      cursor:pointer;
      opacity:.95;
      user-select:none;
    }
    .linklike:hover{ opacity:1; text-decoration:underline; }

    /* ===== Layout ===== */
    .app-shell{
      max-width: 1800px;
      margin: 18px auto 46px;
      padding: 0 18px;
    }

    .shell-card{
      border-radius: var(--r1);
      background: linear-gradient(180deg, rgba(255,255,255,.52), rgba(255,255,255,.26));
      border: 1px solid rgba(255,255,255,.55);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: calc(100vh - 120px);
    }

    /* ===== Tabs ===== */
    .tabs{
      display:flex;
      gap: 12px;
      padding: 14px 16px;
      border-bottom:1px solid rgba(255,255,255,.55);
      background: linear-gradient(180deg, rgba(255,255,255,.56), rgba(255,255,255,.28));
      align-items:center;
      flex-wrap:wrap;
    }
    .tab{
      padding: 12px 18px;
      border-radius: 14px;
      border: 1px solid rgba(190,200,220,.9);
      background: rgba(255,255,255,.72);
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(12,18,40,.10);
      font-size: 16px;
      user-select:none;
    }
    .tab.active{
      background: linear-gradient(180deg, var(--blue1), var(--blue2));
      color:#fff;
      border-color: rgba(30,79,211,.55);
      box-shadow: 0 18px 34px rgba(30,79,211,.28);
    }

    .content{ padding: 18px; }

    /* ===== Cards, inputs, buttons ===== */
    .card{
      border-radius: var(--r2);
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      padding: 16px;
    }
    .card h3{
      margin: 0 0 12px;
      font-size: 20px;
      letter-spacing:.2px;
    }
    .muted{
      color: var(--muted);
      font-weight: 700;
    }
    .hr{
      height:1px;
      background: rgba(190,200,220,.8);
      margin: 12px 0;
    }

    label{ font-weight:900; color:#222a3f; }
    .row{ display:flex; gap:12px; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:10px; }

    input[type="text"], input[type="password"], input[type="date"], select{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(190,200,220,.95);
      background: rgba(255,255,255,.90);
      outline:none;
      font-size: 16px;
      font-weight: 800;
      box-shadow: 0 10px 18px rgba(12,18,40,.08) inset;
    }
    input:focus, select:focus{
      box-shadow: var(--focus), 0 10px 18px rgba(12,18,40,.08) inset;
      border-color: rgba(47,108,246,.55);
    }

    .btn{
      user-select:none;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid rgba(30,79,211,.55);
      background: linear-gradient(180deg, var(--blue1), var(--blue2));
      color:#fff;
      font-weight: 950;
      cursor:pointer;
      box-shadow: 0 18px 30px rgba(30,79,211,.26);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size: 16px;
    }
    .btn:hover{ filter:brightness(1.03); }
    .btn:active{ transform: translateY(1px); }

    .btn.secondary{
      background: rgba(255,255,255,.86);
      color:#1f273b;
      border: 1px solid rgba(190,200,220,.95);
      box-shadow: 0 14px 26px rgba(12,18,40,.12);
    }
    .btn.danger{
      background: linear-gradient(180deg, #ff5a5f, var(--danger));
      border-color: rgba(214,54,58,.7);
      box-shadow: 0 18px 30px rgba(214,54,58,.22);
    }
    .btn.wide{ width:100%; font-size:18px; padding: 16px 18px; }

    /* ===== Big dashboard grids ===== */
    .grid-user, .grid-any{
      display:grid;
      grid-template-columns: 420px 1fr 360px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1200px){
      .grid-user, .grid-any{ grid-template-columns: 1fr; }
      .actions{ width:auto; }
    }

    /* ===== Stats ===== */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
    }
    @media (max-width: 1200px){
      .stats{ grid-template-columns: repeat(2, 1fr); }
    }
    .stat{
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.62));
      border: 1px solid rgba(190,200,220,.9);
      box-shadow: var(--shadow2);
      padding: 16px;
      text-align:center;
    }
    .stat .k{
      font-weight: 950;
      font-size: 16px;
      color:#293252;
    }
    .stat .v{
      margin-top: 10px;
      font-size: 54px;
      font-weight: 950;
      line-height:1;
      letter-spacing:-1px;
    }
    .stat .sub{
      margin-top: 8px;
      font-size: 15px;
      font-weight: 900;
      color: var(--muted);
      line-height:1.25;
    }

    /* ===== Tables ===== */
    .table-wrap{
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(190,200,220,.95);
      background: rgba(255,255,255,.78);
      box-shadow: 0 14px 28px rgba(12,18,40,.10);
    }
    table{
      width: 100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(217,222,234,.95);
      background: rgba(255,255,255,.78);
      box-shadow: 0 10px 18px rgba(25,35,70,.10);
    }
    th, td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(190,200,220,.9);
      font-size: 14px;
      font-weight: 800;
      color:#1e2740;
      vertical-align: top;
    }
    th{
      background: rgba(240,244,255,.90);
      font-weight: 950;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tr:last-child td{ border-bottom:none; }
    .td-muted{ color: var(--muted); font-weight: 850; }
    .right{ text-align:right; }
    .table-scroll{ max-height: 56vh; overflow:auto; }

    /* ===== Date chooser ===== */
    .chooser{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .chip{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(190,200,220,.95);
      background: rgba(255,255,255,.86);
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
      font-size: 16px;
    }
    .chip.active{
      background: linear-gradient(180deg, var(--blue1), var(--blue2));
      color:#fff;
      border-color: rgba(30,79,211,.55);
      box-shadow: 0 18px 28px rgba(30,79,211,.24);
    }

    /* ===== Modals & toast ===== */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(10,14,26,.58);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding: 18px;
    }
    .modal{
      width: min(620px, 96vw);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.78));
      border: 1px solid rgba(255,255,255,.68);
      box-shadow: 0 26px 70px rgba(0,0,0,.32);
      padding: 18px;
    }
    .modal h2{ margin:0 0 12px; font-size: 24px; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(22,28,50,.94);
      color:#fff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.28);
      z-index:1100;
      font-weight: 950;
      display:none;
    }

    /* ===== Login ===== */
    .login-wrap{
      min-height: calc(100vh - 72px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 26px 16px;
    }
    .login-card{
      width: min(720px, 96vw);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      border: 1px solid rgba(255,255,255,.70);
      box-shadow: var(--shadow);
      padding: 26px;
      text-align:center;
    }
    .login-card h1{
      margin:0 0 10px;
      font-size: 54px;
      font-weight: 950;
      letter-spacing:.3px;
    }
    .underline{
      height: 5px;
      width: 120px;
      margin: 12px auto 20px;
      border-radius: 999px;
      background: var(--blue1);
      box-shadow: 0 14px 24px rgba(30,79,211,.25);
    }
    .login-form{
      display:flex;
      flex-direction:column;
      gap: 14px;
      text-align:left;
      margin-top: 8px;
    }
    .login-btn{
      margin-top: 8px;
      border-radius: 16px;
      padding: 18px 18px;
      font-size: 30px;
      letter-spacing:.6px;
      text-transform: lowercase;
    }
    .hint{
      margin-top: 12px;
      font-size: 14px;
      color: var(--muted);
      font-weight: 800;
      text-align:center;
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar hidden" id="topbar">
    <div class="topbar-inner">
      <div style="width:360px"></div>
      <div class="brand">Feedback Tracker</div>
      <div class="actions">
        <span class="pill" id="whoami">‚Äî</span>
        <span class="linklike" id="btnChangePwd">üîí Change Password</span>
        <span class="linklike" id="btnLogout">Logout</span>
      </div>
    </div>
  </div>

  <!-- LOGIN -->
  <div class="login-wrap" id="loginView">
    <div class="login-card">
      <h1>Feedback Tracker</h1>
      <div class="underline"></div>

      <div class="login-form">
        <div class="col">
          <label>Login</label>
          <input id="loginInput" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 60078903" autocomplete="username" />
        </div>
        <div class="col">
          <label>Password</label>
          <input id="passwordInput" type="password" placeholder="******" autocomplete="current-password" />
        </div>
        <button class="btn wide login-btn" id="btnLogin">login</button>
      </div>

      <div class="hint">
        –î–µ–º–æ admin: <b>60078903</b> / <b>123456</b>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app-shell hidden" id="appView">
    <div class="shell-card">
      <div class="tabs">
        <div class="tab active" data-tab="userTab" id="tabUser">User</div>
        <div class="tab" data-tab="shortpickTab" id="tabShortpick">Shortpick</div>
        <div class="tab" data-tab="auditPickTab" id="tabAuditPick">Audit pick</div>
        <div class="tab" data-tab="auditPATab" id="tabAuditPA">Audit PA</div>
        <div class="tab" data-tab="usersTab" id="tabUsers">User management</div>
        <div class="tab" data-tab="importsTab" id="tabImports">Imports</div>
      </div>

      <div class="content">
        <!-- USER TAB -->
        <div id="userTab">
          <div class="grid-user">
            <div class="card">
              <h3>Search (User)</h3>
              <div class="col">
                <label>Login</label>
                <input id="userSearchLogin" type="text" placeholder="–≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (–∏–ª–∏ –ø—É—Å—Ç–æ –¥–ª—è –≤—Å–µ—Ö)" />
                <button class="btn wide" id="btnUserSearch">Search</button>
              </div>
              <div class="hr"></div>
              <div class="muted">
                ‚Ä¢ –µ—Å–ª–∏ –ª–æ–≥–∏–Ω –ø—É—Å—Ç–æ–π ‚Äî –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ—Ö<br>
                ‚Ä¢ —Ñ–∏–ª—å—Ç—Ä –¥–∞—Ç —Å–ø—Ä–∞–≤–∞
              </div>
              <div class="hr"></div>
              <button class="btn wide" id="btnExportFromUser">‚¨á Export current view</button>
            </div>

            <div class="col" style="gap:16px;">
              <div class="stats">
                <div class="stat">
                  <div class="k">Shortpick</div>
                  <div class="v" id="statShortpick">0</div>
                  <div class="sub">rows</div>
                </div>
                <div class="stat">
                  <div class="k">Audit pick</div>
                  <div class="v" id="statAuditPickAll">0</div>
                  <div class="sub">all</div>
                </div>
                <div class="stat">
                  <div class="k">Audit PA</div>
                  <div class="v" id="statAuditPAAll">0</div>
                  <div class="sub">all</div>
                </div>
                <div class="stat">
                  <div class="k">Period</div>
                  <div class="v" style="font-size:18px; margin-top:14px;" id="statPeriod">‚Äî</div>
                  <div class="sub">range</div>
                </div>
              </div>

              <div class="card">
                <h3>All feedback (by Date)</h3>
                <div id="userByDateTableWrap"></div>
              </div>
            </div>

            <div class="card">
              <h3>Choose Date</h3>
              <div class="chooser" id="userChooser">
                <div class="chip active" data-mode="day">üìÖ Day</div>
                <div class="chip" data-mode="week">üóì Week</div>
                <div class="chip" data-mode="month">üóì Month</div>
                <div class="chip" data-mode="custom">üóì Custom Date</div>
              </div>
              <div class="hr"></div>
              <div class="col" id="dateInputs"></div>
              <button class="btn wide" id="btnApplyDate">Apply</button>
            </div>
          </div>
        </div>

        <!-- SHORTPICK TAB -->
        <div id="shortpickTab" class="hidden">
          <div class="grid-any">
            <div class="card">
              <h3>Search (Shortpick)</h3>
              <div class="col">
                <label>Login (Picker)</label>
                <input id="spSearchLogin" type="text" placeholder="–≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (–∏–ª–∏ –ø—É—Å—Ç–æ –¥–ª—è –≤—Å–µ—Ö)" />
                <button class="btn wide" id="btnSpSearch">Search</button>
              </div>
              <div class="hr"></div>
              <button class="btn wide" id="btnExportShortpick">‚¨á Export Shortpick</button>
            </div>

            <div class="card">
              <div class="row" style="justify-content:space-between; align-items:flex-end; gap:14px;">
                <div>
                  <h3 style="margin:0">Shortpick (details)</h3>
                  <div class="muted" id="spPageInfo" style="margin-top:6px;">Page 1</div>
                </div>
                <div class="row">
                  <button class="btn secondary" id="spPrev">‚Üê Prev</button>
                  <button class="btn secondary" id="spNext">Next ‚Üí</button>
                </div>
              </div>
              <div class="hr"></div>
              <div class="table-wrap table-scroll" id="shortpickTableWrap"></div>
            </div>

            <div class="card">
              <h3>Choose Date</h3>
              <div class="chooser" id="spChooser">
                <div class="chip active" data-mode="day">üìÖ Day</div>
                <div class="chip" data-mode="week">üóì Week</div>
                <div class="chip" data-mode="month">üóì Month</div>
                <div class="chip" data-mode="custom">üóì Custom Date</div>
              </div>
              <div class="hr"></div>
              <div class="col" id="spDateInputs"></div>
              <button class="btn wide" id="btnApplySpDate">Apply</button>
            </div>
          </div>
        </div>

        <!-- AUDIT PICK TAB -->
        <div id="auditPickTab" class="hidden">
          <div class="grid-any">
            <div class="card">
              <h3>Search (Audit pick)</h3>
              <div class="col">
                <label>Login (Picker)</label>
                <input id="apSearchLogin" type="text" placeholder="–≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (–∏–ª–∏ –ø—É—Å—Ç–æ –¥–ª—è –≤—Å–µ—Ö)" />
                <label>Result</label>
                <select id="apResult">
                  <option value="all">All</option>
                  <option value="profit">Profit</option>
                  <option value="loss">Loss</option>
                </select>
                <button class="btn wide" id="btnApSearch">Search</button>
              </div>
              <div class="hr"></div>
              <button class="btn wide" id="btnExportAuditPick">‚¨á Export Audit pick</button>
              <div class="hr"></div>
              <div class="muted">
                Stats: Profit / Loss / All
              </div>
            </div>

            <div class="col" style="gap:16px;">
              <div class="stats">
                <div class="stat"><div class="k">Profit</div><div class="v" id="apStatProfit">0</div><div class="sub">rows</div></div>
                <div class="stat"><div class="k">Loss</div><div class="v" id="apStatLoss">0</div><div class="sub">rows</div></div>
                <div class="stat"><div class="k">All</div><div class="v" id="apStatAll">0</div><div class="sub">rows</div></div>
                <div class="stat"><div class="k">Period</div><div class="v" style="font-size:18px; margin-top:14px;" id="apStatPeriod">‚Äî</div><div class="sub">range</div></div>
              </div>

              <div class="card">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:14px;">
                  <div>
                    <h3 style="margin:0">Audit pick (details)</h3>
                    <div class="muted" id="apPageInfo" style="margin-top:6px;">Page 1</div>
                  </div>
                  <div class="row">
                    <button class="btn secondary" id="apPrev">‚Üê Prev</button>
                    <button class="btn secondary" id="apNext">Next ‚Üí</button>
                  </div>
                </div>
                <div class="hr"></div>
                <div class="table-wrap table-scroll" id="auditPickTableWrap"></div>
              </div>
            </div>

            <div class="card">
              <h3>Choose Date</h3>
              <div class="chooser" id="apChooser">
                <div class="chip active" data-mode="day">üìÖ Day</div>
                <div class="chip" data-mode="week">üóì Week</div>
                <div class="chip" data-mode="month">üóì Month</div>
                <div class="chip" data-mode="custom">üóì Custom Date</div>
              </div>
              <div class="hr"></div>
              <div class="col" id="apDateInputs"></div>
              <button class="btn wide" id="btnApplyApDate">Apply</button>
            </div>
          </div>
        </div>

        <!-- AUDIT PA TAB -->
        <div id="auditPATab" class="hidden">
          <div class="grid-any">
            <div class="card">
              <h3>Search (Audit PA)</h3>
              <div class="col">
                <label>Login (Packer)</label>
                <input id="paSearchLogin" type="text" placeholder="–≤–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (–∏–ª–∏ –ø—É—Å—Ç–æ –¥–ª—è –≤—Å–µ—Ö)" />
                <label>Result</label>
                <select id="paResult">
                  <option value="all">All</option>
                  <option value="profit">Profit</option>
                  <option value="loss">Loss</option>
                  <option value="occupied">Occupied</option>
                </select>
                <button class="btn wide" id="btnPaSearch">Search</button>
              </div>
              <div class="hr"></div>
              <button class="btn wide" id="btnExportAuditPA">‚¨á Export Audit PA</button>
              <div class="hr"></div>
              <div class="muted">
                Stats: Profit / Loss / Occupied / All
              </div>
            </div>

            <div class="col" style="gap:16px;">
              <div class="stats">
                <div class="stat"><div class="k">Profit</div><div class="v" id="paStatProfit">0</div><div class="sub">rows</div></div>
                <div class="stat"><div class="k">Loss</div><div class="v" id="paStatLoss">0</div><div class="sub">rows</div></div>
                <div class="stat"><div class="k">Occupied</div><div class="v" id="paStatOcc">0</div><div class="sub">rows</div></div>
                <div class="stat"><div class="k">All</div><div class="v" id="paStatAll">0</div><div class="sub">rows</div></div>
              </div>

              <div class="card">
                <div class="row" style="justify-content:space-between; align-items:flex-end; gap:14px;">
                  <div>
                    <h3 style="margin:0">Audit PA (details)</h3>
                    <div class="muted" id="paPageInfo" style="margin-top:6px;">Page 1</div>
                  </div>
                  <div class="row">
                    <button class="btn secondary" id="paPrev">‚Üê Prev</button>
                    <button class="btn secondary" id="paNext">Next ‚Üí</button>
                  </div>
                </div>
                <div class="hr"></div>
                <div class="table-wrap table-scroll" id="auditPATableWrap"></div>
              </div>
            </div>

            <div class="card">
              <h3>Choose Date</h3>
              <div class="chooser" id="paChooser">
                <div class="chip active" data-mode="day">üìÖ Day</div>
                <div class="chip" data-mode="week">üóì Week</div>
                <div class="chip" data-mode="month">üóì Month</div>
                <div class="chip" data-mode="custom">üóì Custom Date</div>
              </div>
              <div class="hr"></div>
              <div class="col" id="paDateInputs"></div>
              <button class="btn wide" id="btnApplyPaDate">Apply</button>
            </div>
          </div>
        </div>

        <!-- USERS TAB -->
        <div id="usersTab" class="hidden">
          <div class="row" style="justify-content:space-between; margin-bottom:14px;">
            <div class="muted" style="font-weight:950; font-size:18px;">User management</div>
            <button class="btn" id="btnAddUser">Add User</button>
          </div>
          <div id="usersTableWrap"></div>
        </div>

        <!-- IMPORTS TAB -->
        <div id="importsTab" class="hidden">
          <div class="row" style="justify-content:space-between; margin-bottom:14px;">
            <div class="muted" style="font-weight:950; font-size:18px;">Imports (Upload Excel ‚Üí Save to system)</div>
            <button class="btn" id="btnAddImport">Add Import</button>
          </div>

          <div class="card" style="margin-bottom:14px;">
            <div class="muted">
              Excel –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±–ª–æ–∫–∏ <b>Shortpick</b>, <b>Audit pick</b>, <b>Audit PA</b> (–∫–∞–∫ –≤ –≤–∞—à–µ–º —à–∞–±–ª–æ–Ω–µ).
            </div>
          </div>

          <div id="importsTableWrap"></div>
          <input id="fileInput" type="file" accept=".xlsx,.xlsm,.xls" class="hidden" />
        </div>
      </div>
    </div>
  </div>

  <!-- CHANGE PASSWORD MODAL -->
  <div class="modal-backdrop hidden" id="pwdModal">
    <div class="modal">
      <h2>Change Password</h2>
      <div class="col" style="gap:12px;">
        <div class="col">
          <label>Current password</label>
          <input id="pwdCurrent" type="password" />
        </div>
        <div class="col">
          <label>New password</label>
          <input id="pwdNew" type="password" />
        </div>
        <div class="col">
          <label>Repeat new password</label>
          <input id="pwdNew2" type="password" />
        </div>
        <div class="row" style="justify-content:flex-end; gap:12px; margin-top:4px;">
          <button class="btn secondary" id="btnPwdCancel">Cancel</button>
          <button class="btn" id="btnPwdSave">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD/EDIT USER MODAL -->
  <div class="modal-backdrop hidden" id="userModal">
    <div class="modal">
      <h2 id="userModalTitle">Add User</h2>
      <div class="col" style="gap:12px;">
        <div class="col">
          <label>Login</label>
          <input id="umLogin" type="text" />
        </div>
        <div class="col">
          <label>Password</label>
          <input id="umPassword" type="password" />
          <div class="muted" style="font-size:13px;">–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å –ø–∞—Ä–æ–ª—å</div>
        </div>
        <div class="col">
          <label>Role</label>
          <select id="umRole">
            <option value="manager">manager</option>
            <option value="admin">admin</option>
          </select>
          <div class="muted" style="font-size:13px;">manager –Ω–µ –≤–∏–¥–∏—Ç –≤–∫–ª–∞–¥–∫—É Imports</div>
        </div>

        <div class="row" style="justify-content:flex-end; gap:12px; margin-top:4px;">
          <button class="btn secondary" id="btnUserCancel">Cancel</button>
          <button class="btn" id="btnUserSave">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">‚Äî</div>

<script>
/** =========================================================
 *  SERVER AUTH + API (–æ–±—â–∞—è –±–∞–∑–∞)
 *  ========================================================= */
const LS_KEYS = {
  token: "ft_token_v1",
  me:    "ft_me_v1"
};

const TYPES = {
  SHORTPICK: "shortpick",
  AUDIT_PICK: "audit_pick",
  AUDIT_PA: "audit_pa"
};

const PAGE_SIZE = 14;

function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 2400);
}

function saveJSON(key, v){ localStorage.setItem(key, JSON.stringify(v)); }
function loadJSON(key, fb){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fb; }
  catch{ return fb; }
}

function getToken(){ return localStorage.getItem(LS_KEYS.token) || ""; }
function setToken(t){ localStorage.setItem(LS_KEYS.token, t); }
function clearToken(){
  localStorage.removeItem(LS_KEYS.token);
  localStorage.removeItem(LS_KEYS.me);
}
function getMe(){ return loadJSON(LS_KEYS.me, null); }
function setMe(me){ saveJSON(LS_KEYS.me, me); }

async function apiFetch(path, { method="GET", headers={}, body=null } = {}){
  const h = { ...headers };
  const token = getToken();
  if(token) h["Authorization"] = "Bearer " + token;

  const res = await fetch(path, { method, headers:h, body });
  const ct = res.headers.get("content-type") || "";
  let data = null;
  try{
    data = ct.includes("application/json") ? await res.json() : await res.text();
  }catch{}
  if(!res.ok){
    const msg = (data && data.error) ? data.error : ("HTTP " + res.status);
    throw new Error(msg);
  }
  return data;
}

function esc(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/** =========================================================
 *  DATE
 *  ========================================================= */
function pad2(n){ return String(n).padStart(2,"0"); }
function toDateOnlyISO(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function startOfWeek(d){
  const x = new Date(d);
  const day = (x.getDay()+6)%7;
  x.setDate(x.getDate()-day);
  x.setHours(0,0,0,0);
  return x;
}
function endOfWeek(d){
  const s = startOfWeek(d);
  const e = new Date(s);
  e.setDate(e.getDate()+6);
  e.setHours(23,59,59,999);
  return e;
}
function startOfMonth(d){
  const x = new Date(d.getFullYear(), d.getMonth(), 1);
  x.setHours(0,0,0,0);
  return x;
}
function endOfMonth(d){
  const x = new Date(d.getFullYear(), d.getMonth()+1, 0);
  x.setHours(23,59,59,999);
  return x;
}
function computeRange(mode, customFrom, customTo){
  const today = new Date(); today.setHours(0,0,0,0);
  if(mode === "day"){
    const s = new Date(today); s.setHours(0,0,0,0);
    const e = new Date(today); e.setHours(23,59,59,999);
    return {from:s, to:e};
  }
  if(mode === "week")  return {from: startOfWeek(today), to: endOfWeek(today)};
  if(mode === "month") return {from: startOfMonth(today), to: endOfMonth(today)};
  const f = customFrom ? new Date(customFrom+"T00:00:00") : new Date(today);
  const t = customTo ? new Date(customTo+"T23:59:59") : new Date(today);
  return {from:f, to:t};
}
function humanRange(from, to){
  if(!from || !to) return "‚Äî";
  const f = toDateOnlyISO(from);
  const t = toDateOnlyISO(to);
  return f === t ? f : `${f} ‚Äî ${t}`;
}

function formatWarsawTime(isoLocal){
  if(!isoLocal) return "";
  const d = new Date(isoLocal);
  if(isNaN(d)) return String(isoLocal).replace("T"," ").slice(0,16);

  const fmt = new Intl.DateTimeFormat("pl-PL", {
    timeZone: "Europe/Warsaw",
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  });
  const parts = fmt.formatToParts(d);
  const get = (t)=> parts.find(p=>p.type===t)?.value || "";
  return `${get("year")}-${get("month")}-${get("day")} ${get("hour")}:${get("minute")}`;
}

/** =========================================================
 *  FILTER STATE
 *  ========================================================= */
const dateState = {
  user: { mode:"day", from:null, to:null, login:"" },
  sp: { mode:"day", from:null, to:null, login:"", page:1 },
  ap: { mode:"day", from:null, to:null, login:"", result:"all", page:1 },
  pa: { mode:"day", from:null, to:null, login:"", result:"all", page:1 }
};

function renderDateInputs(containerId, stateKey){
  const st = dateState[stateKey];
  const el = document.getElementById(containerId);
  el.innerHTML = "";

  if(st.mode === "custom"){
    el.innerHTML = `
      <div class="row">
        <div class="col" style="flex:1;">
          <label>From</label>
          <input type="date" id="${stateKey}From" />
        </div>
        <div class="col" style="flex:1;">
          <label>To</label>
          <input type="date" id="${stateKey}To" />
        </div>
      </div>
    `;
    const f = st.from ? toDateOnlyISO(st.from) : toDateOnlyISO(new Date());
    const t = st.to ? toDateOnlyISO(st.to) : toDateOnlyISO(new Date());
    setTimeout(()=>{
      document.getElementById(`${stateKey}From`).value = f;
      document.getElementById(`${stateKey}To`).value = t;
    },0);
  }else{
    const {from,to} = computeRange(st.mode);
    st.from = from; st.to = to;
    el.innerHTML = `
      <div class="muted">–¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥:</div>
      <div style="font-weight:950; font-size:18px; margin-top:8px;">${humanRange(from,to)}</div>
    `;
  }
}
function applyDate(stateKey){
  const st = dateState[stateKey];
  if(st.mode === "custom"){
    const fromVal = document.getElementById(`${stateKey}From`).value;
    const toVal   = document.getElementById(`${stateKey}To`).value;
    const {from,to} = computeRange("custom", fromVal, toVal);
    st.from = from; st.to = to;
  }else{
    const {from,to} = computeRange(st.mode);
    st.from = from; st.to = to;
  }
}

/** =========================================================
 *  ROLE UI
 *  ========================================================= */
function enforceRoleUI(){
  const me = getMe();
  if(!me) return;

  const importsTab = document.getElementById("tabImports");
  importsTab.classList.toggle("hidden", me.role !== "admin");
  if(me.role !== "admin"){
    const active = document.querySelector(".tab.active");
    if(active && active.id === "tabImports") setTab("userTab");
  }
  document.getElementById("whoami").textContent = `${me.login} (${me.role})`;
}

/** =========================================================
 *  TAB CONTROL
 *  ========================================================= */
function setTab(tabId){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab === tabId);
  });

  ["userTab","shortpickTab","auditPickTab","auditPATab","usersTab","importsTab"].forEach(id=>{
    document.getElementById(id).classList.toggle("hidden", id !== tabId);
  });

  if(tabId==="userTab") renderUserTab().catch(console.error);
  if(tabId==="shortpickTab") renderShortpickTab().catch(console.error);
  if(tabId==="auditPickTab") renderAuditPickTab().catch(console.error);
  if(tabId==="auditPATab") renderAuditPATab().catch(console.error);
  if(tabId==="usersTab") renderUsersTab().catch(console.error);
  if(tabId==="importsTab") renderImportsTab().catch(console.error);
}

/** =========================================================
 *  API HELPERS
 *  ========================================================= */
async function apiRecords({type, login, from, to, result, page, pageSize}){
  const qs = new URLSearchParams();
  if(type) qs.set("type", type);
  if(login) qs.set("login", login);
  if(from) qs.set("from", from);
  if(to) qs.set("to", to);
  if(result) qs.set("result", result);
  qs.set("page", String(page||1));
  qs.set("pageSize", String(pageSize||PAGE_SIZE));
  return apiFetch("/api/records?" + qs.toString());
}

/** =========================================================
 *  RENDER: USER TAB (summary)
 *  ========================================================= */
async function renderUserTab(){
  document.getElementById("userSearchLogin").value = dateState.user.login || "";

  const st = dateState.user;
  const from = toDateOnlyISO(st.from);
  const to = toDateOnlyISO(st.to);

  const qs = new URLSearchParams();
  if(st.login) qs.set("login", st.login.trim());
  qs.set("from", from);
  qs.set("to", to);

  const summary = await apiFetch("/api/user-summary?" + qs.toString());

  document.getElementById("statShortpick").textContent = summary.shortpick || 0;
  document.getElementById("statAuditPickAll").textContent = summary.audit_pick?.all || 0;
  document.getElementById("statAuditPAAll").textContent = summary.audit_pa?.all || 0;
  document.getElementById("statPeriod").textContent = humanRange(st.from, st.to);

  const wrap = document.getElementById("userByDateTableWrap");
  const grouped = summary.grouped || [];

  if(grouped.length === 0){
    wrap.innerHTML = `<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</div>`;
    return;
  }

  const rows = grouped.map(x=>`
    <tr>
      <td class="td-muted">${esc(x.date)}</td>
      <td class="right" style="font-size:18px;color:var(--blue1);">${esc(x.count)}</td>
    </tr>
  `).join("");

  const ap = summary.audit_pick || {profit:0,loss:0,all:0};
  const pa = summary.audit_pa || {profit:0,loss:0,occupied:0,all:0};

  wrap.innerHTML = `
    <div class="table-wrap">
      <table>
        <thead><tr><th>Date</th><th class="right">Count (ALL)</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class="hr"></div>
    <div class="muted">
      Audit pick: Profit <b>${ap.profit||0}</b> ‚Ä¢ Loss <b>${ap.loss||0}</b> ‚Ä¢ All <b>${ap.all||0}</b><br>
      Audit PA: Profit <b>${pa.profit||0}</b> ‚Ä¢ Loss <b>${pa.loss||0}</b> ‚Ä¢ Occupied <b>${pa.occupied||0}</b> ‚Ä¢ All <b>${pa.all||0}</b>
    </div>
  `;
}

/** =========================================================
 *  RENDER: SHORTPICK
 *  ========================================================= */
async function renderShortpickTab(){
  const st = dateState.sp;
  document.getElementById("spSearchLogin").value = st.login || "";

  const from = toDateOnlyISO(st.from);
  const to = toDateOnlyISO(st.to);

  const data = await apiRecords({
    type: TYPES.SHORTPICK,
    login: st.login || "",
    from, to,
    page: st.page,
    pageSize: PAGE_SIZE
  });

  const totalPages = Math.max(1, Math.ceil((data.total||0) / PAGE_SIZE));
  st.page = Math.min(st.page, totalPages);

  document.getElementById("spPageInfo").textContent =
    `Page ${st.page} / ${totalPages} (${data.total||0} rows)`;

  const wrap = document.getElementById("shortpickTableWrap");
  const rowsArr = data.rows || [];
  if(rowsArr.length === 0){
    wrap.innerHTML = `<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</div>`;
    return;
  }

  const rows = rowsArr.map(r=>`
    <tr>
      <td class="td-muted">${esc(r.date||"")}</td>
      <td>${esc(r.task_order||"")}</td>
      <td>${esc(r.sku||"")}</td>
      <td>${esc(r.box_number||"")}</td>
      <td class="td-muted">${esc(formatWarsawTime(r.time))}</td>
      <td>${esc(r.person_login||"")}</td>
    </tr>
  `).join("");

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:120px;">Date</th>
          <th>Task order</th>
          <th style="width:180px;">SKU</th>
          <th style="width:170px;">Box number</th>
          <th style="width:170px;">Time (Warsaw)</th>
          <th style="width:140px;">Login</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/** =========================================================
 *  RENDER: AUDIT PICK
 *  ========================================================= */
async function renderAuditPickTab(){
  const st = dateState.ap;
  document.getElementById("apSearchLogin").value = st.login || "";
  document.getElementById("apResult").value = st.result || "all";

  const from = toDateOnlyISO(st.from);
  const to = toDateOnlyISO(st.to);

  // stats –±–µ—Ä—ë–º —á–µ—Ä–µ–∑ user-summary? (—Ç—É—Ç –ø—Ä–æ—â–µ: –∑–∞–ø—Ä–æ—Å–∏–º user-summary –±–µ–∑ type)
  // —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã ‚Äî –æ—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ period —Ç–µ–∫—Å—Ç–æ–º.
  document.getElementById("apStatPeriod").textContent = humanRange(st.from, st.to);

  const data = await apiRecords({
    type: TYPES.AUDIT_PICK,
    login: st.login || "",
    from, to,
    result: st.result || "all",
    page: st.page,
    pageSize: PAGE_SIZE
  });

  // –°—á—ë—Ç—á–∏–∫–∏ profit/loss/all —Å—á–∏—Ç–∞–µ–º –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ? ‚Äî –Ω–µ –∏–¥–µ–∞–ª—å–Ω–æ.
  // –ü–æ—ç—Ç–æ–º—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "All" –∫–∞–∫ total —Ñ–∏–ª—å—Ç—Ä–∞ + –¥—Ä—É–≥–∏–µ ‚Äî –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É /api/user-summary (–≤–∫–ª—é—á–∞–µ—Ç –æ–±—â–∏–π all, profit/loss).
  const sumQS = new URLSearchParams();
  if(st.login) sumQS.set("login", st.login);
  sumQS.set("from", from); sumQS.set("to", to);
  const summary = await apiFetch("/api/user-summary?" + sumQS.toString());
  const ap = summary.audit_pick || {profit:0,loss:0,all:0};

  document.getElementById("apStatProfit").textContent = ap.profit || 0;
  document.getElementById("apStatLoss").textContent = ap.loss || 0;
  document.getElementById("apStatAll").textContent = ap.all || 0;

  const totalPages = Math.max(1, Math.ceil((data.total||0) / PAGE_SIZE));
  st.page = Math.min(st.page, totalPages);

  document.getElementById("apPageInfo").textContent =
    `Page ${st.page} / ${totalPages} (${data.total||0} rows)`;

  const wrap = document.getElementById("auditPickTableWrap");
  const rowsArr = data.rows || [];
  if(rowsArr.length === 0){
    wrap.innerHTML = `<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</div>`;
    return;
  }

  const rows = rowsArr.map(r=>`
    <tr>
      <td class="td-muted">${esc(r.date||"")}</td>
      <td>${esc(r.person_login||"")}</td>
      <td>${esc(r.container||"")}</td>
      <td>${esc(r.sku||"")}</td>
      <td>${esc(r.auditor||"")}</td>
      <td><b>${esc(r.result||"")}</b></td>
    </tr>
  `).join("");

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:120px;">Date</th>
          <th style="width:140px;">Picker login</th>
          <th style="width:180px;">Container</th>
          <th style="width:200px;">SKU</th>
          <th style="width:160px;">Audytor</th>
          <th style="width:120px;">Result</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/** =========================================================
 *  RENDER: AUDIT PA
 *  ========================================================= */
async function renderAuditPATab(){
  const st = dateState.pa;
  document.getElementById("paSearchLogin").value = st.login || "";
  document.getElementById("paResult").value = st.result || "all";

  const from = toDateOnlyISO(st.from);
  const to = toDateOnlyISO(st.to);

  const data = await apiRecords({
    type: TYPES.AUDIT_PA,
    login: st.login || "",
    from, to,
    result: st.result || "all",
    page: st.page,
    pageSize: PAGE_SIZE
  });

  const sumQS = new URLSearchParams();
  if(st.login) sumQS.set("login", st.login);
  sumQS.set("from", from); sumQS.set("to", to);
  const summary = await apiFetch("/api/user-summary?" + sumQS.toString());
  const pa = summary.audit_pa || {profit:0,loss:0,occupied:0,all:0};

  document.getElementById("paStatProfit").textContent = pa.profit || 0;
  document.getElementById("paStatLoss").textContent = pa.loss || 0;
  document.getElementById("paStatOcc").textContent = pa.occupied || 0;
  document.getElementById("paStatAll").textContent = pa.all || 0;

  const totalPages = Math.max(1, Math.ceil((data.total||0) / PAGE_SIZE));
  st.page = Math.min(st.page, totalPages);

  document.getElementById("paPageInfo").textContent =
    `Page ${st.page} / ${totalPages} (${data.total||0} rows)`;

  const wrap = document.getElementById("auditPATableWrap");
  const rowsArr = data.rows || [];
  if(rowsArr.length === 0){
    wrap.innerHTML = `<div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</div>`;
    return;
  }

  const rows = rowsArr.map(r=>`
    <tr>
      <td class="td-muted">${esc(r.date||"")}</td>
      <td>${esc(r.person_login||"")}</td>
      <td>${esc(r.container||"")}</td>
      <td>${esc(r.sku||"")}</td>
      <td>${esc(r.auditor||"")}</td>
      <td><b>${esc(r.result||"")}</b></td>
    </tr>
  `).join("");

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:120px;">Date</th>
          <th style="width:140px;">Packer login</th>
          <th style="width:180px;">Container</th>
          <th style="width:200px;">SKU</th>
          <th style="width:160px;">Audytor</th>
          <th style="width:120px;">Result</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/** =========================================================
 *  USERS TAB (server)
 *  ========================================================= */
async function renderUsersTab(){
  const me = getMe();
  if(!me) return;

  const data = await apiFetch("/api/users");
  const users = data.rows || [];

  const rows = users.map(u=>{
    const canEdit = (me.role === "admin" || me.role === "manager");
    const canDelete = (me.role === "admin" || me.role === "manager");
    return `
      <tr>
        <td style="font-size:18px;font-weight:950;">${esc(u.login)}</td>
        <td>${esc(u.role)}</td>
        <td class="right">${canEdit ? `<button class="btn secondary" data-action="editUser" data-id="${u.id}">Edit</button>` : ""}</td>
        <td class="right">${canDelete ? `<button class="btn danger" data-action="delUser" data-id="${u.id}">Delete</button>` : ""}</td>
      </tr>
    `;
  }).join("");

  document.getElementById("usersTableWrap").innerHTML = `
    <div class="table-wrap">
      <table>
        <thead><tr><th>User</th><th>Role</th><th class="right">Edit</th><th class="right">Delete</th></tr></thead>
        <tbody>${rows || `<tr><td colspan="4" class="td-muted">No users</td></tr>`}</tbody>
      </table>
    </div>
  `;
}

/** =========================================================
 *  IMPORTS TAB (server admin only)
 *  ========================================================= */
async function renderImportsTab(){
  const me = getMe();
  if(!me) return;
  if(me.role !== "admin"){
    document.getElementById("importsTableWrap").innerHTML =
      `<div class="muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ admin).</div>`;
    return;
  }

  const data = await apiFetch("/api/imports");
  const imports = data.rows || [];

  const rows = imports.map(im=>`
    <tr>
      <td><a href="#" data-action="downloadImport" data-id="${im.id}">${esc(im.name)}</a></td>
      <td class="td-muted">${esc((im.uploaded_at||"").slice(0,10))}</td>
      <td>${esc(im.creator_login||"")}</td>
      <td class="td-muted right">${esc(im.rows_count||0)}</td>
      <td class="right"><button class="btn danger" data-action="deleteImport" data-id="${im.id}">Delete</button></td>
    </tr>
  `).join("");

  document.getElementById("importsTableWrap").innerHTML = `
    <div class="table-wrap">
      <table>
        <thead><tr><th>Name</th><th>Date</th><th>Creator</th><th class="right">Rows</th><th class="right">Delete</th></tr></thead>
        <tbody>${rows || `<tr><td colspan="5" class="td-muted">No imports yet</td></tr>`}</tbody>
      </table>
    </div>
  `;
}

/** =========================================================
 *  EXPORT (–±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–∏—à–µ–º –≤ Excel)
 *  ========================================================= */
function downloadBlob(filename, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function exportRowsToExcel(rows, sheetName, filename){
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  const out = XLSX.write(wb, {bookType:"xlsx", type:"array"});
  downloadBlob(filename, new Blob([out], {type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}));
}

/** =========================================================
 *  MODALS (User management UI) - –ª–æ–∫–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
 *  ========================================================= */
let userModalState = { mode:"add", user:null };

function openUserModal({mode, user}){
  const me = getMe();
  userModalState.mode = mode;
  userModalState.user = user || null;

  document.getElementById("userModalTitle").textContent = (mode==="add") ? "Add User" : "Edit User";
  document.getElementById("umLogin").value = user ? user.login : "";
  document.getElementById("umLogin").disabled = (mode==="edit");
  document.getElementById("umPassword").value = "";

  const roleSelect = document.getElementById("umRole");
  roleSelect.innerHTML = "";
  const opts = (me.role === "admin") ? ["manager","admin"] : ["manager"];
  for(const r of opts){
    const o = document.createElement("option");
    o.value = r; o.textContent = r;
    roleSelect.appendChild(o);
  }
  roleSelect.value = user ? (opts.includes(user.role) ? user.role : "manager") : "manager";

  document.getElementById("userModal").classList.remove("hidden");
}

async function saveUserFromModal(){
  const me = getMe();
  const login = document.getElementById("umLogin").value.trim();
  const pwd = document.getElementById("umPassword").value;
  const role = document.getElementById("umRole").value;

  if(!login){ toast("Login –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"); return; }
  if(userModalState.mode === "add" && !pwd){ toast("Password –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"); return; }

  try{
    if(userModalState.mode === "add"){
      await apiFetch("/api/users", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ login, password: pwd, role })
      });
      toast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω");
    }else{
      await apiFetch("/api/users/" + userModalState.user.id, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ role, password: pwd || undefined })
      });
      toast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω");
    }

    document.getElementById("userModal").classList.add("hidden");
    await renderUsersTab();
    enforceRoleUI();
  }catch(e){
    toast("–û—à–∏–±–∫–∞: " + e.message);
  }
}

/** =========================================================
 *  BIND UI
 *  ========================================================= */
function bindTabs(){
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      const me = getMe();
      if(t.id==="tabImports" && me?.role !== "admin"){
        toast("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ Imports (—Ç–æ–ª—å–∫–æ admin)");
        return;
      }
      setTab(t.dataset.tab);
    });
  });
}

function bindChooser(groupId, stateKey, inputsId){
  document.querySelectorAll(`#${groupId} .chip`).forEach(ch=>{
    ch.addEventListener("click", ()=>{
      document.querySelectorAll(`#${groupId} .chip`).forEach(x=>x.classList.remove("active"));
      ch.classList.add("active");
      dateState[stateKey].mode = ch.dataset.mode;
      renderDateInputs(inputsId, stateKey);
    });
  });
}

function bindCoreButtons(){
  // LOGIN (server)
  document.getElementById("btnLogin").addEventListener("click", async ()=>{
    const login = document.getElementById("loginInput").value.trim();
    const password  = document.getElementById("passwordInput").value;
    try{
      const r = await apiFetch("/api/auth/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ login, password })
      });
      setToken(r.token);
      setMe(r.user);
      openApp();
      toast("–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥");
    }catch(e){
      toast("–ù–µ–≤–µ—Ä–Ω—ã–π login/password");
    }
  });

  // LOGOUT
  document.getElementById("btnLogout").addEventListener("click", ()=>{
    clearToken();
    openLogin();
  });

  // CHANGE PASSWORD (server)
  document.getElementById("btnChangePwd").addEventListener("click", ()=>{
    document.getElementById("pwdCurrent").value="";
    document.getElementById("pwdNew").value="";
    document.getElementById("pwdNew2").value="";
    document.getElementById("pwdModal").classList.remove("hidden");
  });
  document.getElementById("btnPwdCancel").addEventListener("click", ()=>{
    document.getElementById("pwdModal").classList.add("hidden");
  });
  document.getElementById("btnPwdSave").addEventListener("click", async ()=>{
    const cur = document.getElementById("pwdCurrent").value;
    const n1  = document.getElementById("pwdNew").value;
    const n2  = document.getElementById("pwdNew2").value;
    if(!cur || !n1 || !n2){ toast("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è"); return; }
    if(n1 !== n2){ toast("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç"); return; }

    try{
      await apiFetch("/api/auth/change-password", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ currentPassword: cur, newPassword: n1 })
      });
      document.getElementById("pwdModal").classList.add("hidden");
      toast("–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω");
    }catch(e){
      toast("–û—à–∏–±–∫–∞: " + e.message);
    }
  });

  // USER: search + date + export
  document.getElementById("btnUserSearch").addEventListener("click", ()=>{
    dateState.user.login = document.getElementById("userSearchLogin").value.trim();
    renderUserTab().catch(console.error);
  });
  document.getElementById("btnApplyDate").addEventListener("click", ()=>{
    applyDate("user");
    renderUserTab().catch(console.error);
  });

  document.getElementById("btnExportFromUser").addEventListener("click", async ()=>{
    try{
      const st = dateState.user;
      const from = toDateOnlyISO(st.from);
      const to = toDateOnlyISO(st.to);
      // –∑–∞–±–∏—Ä–∞–µ–º –ø–æ–±–æ–ª—å—à–µ
      const data = await apiRecords({
        type:"",
        login: st.login || "",
        from, to,
        page:1,
        pageSize:500
      });
      const rows = (data.rows||[]).map(r=>({
        Type: r.type,
        Date: r.date,
        Time: (r.time||"").replace("T"," "),
        Login: r.person_login || "",
        TaskOrder: r.task_order || "",
        SKU: r.sku || "",
        BoxNumber: r.box_number || "",
        Container: r.container || "",
        Audytor: r.auditor || "",
        Result: r.result || ""
      }));
      if(!rows.length){ toast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞"); return; }
      const name = `ALL_${from}-${to}.xlsx`;
      exportRowsToExcel(rows, "All", name);
    }catch(e){
      toast("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " + e.message);
    }
  });

  // SHORTPICK: search + date + paging + export
  document.getElementById("btnSpSearch").addEventListener("click", ()=>{
    dateState.sp.login = document.getElementById("spSearchLogin").value.trim();
    dateState.sp.page = 1;
    renderShortpickTab().catch(console.error);
  });
  document.getElementById("btnApplySpDate").addEventListener("click", ()=>{
    applyDate("sp");
    dateState.sp.page = 1;
    renderShortpickTab().catch(console.error);
  });
  document.getElementById("spPrev").addEventListener("click", ()=>{
    dateState.sp.page = Math.max(1, dateState.sp.page-1);
    renderShortpickTab().catch(console.error);
  });
  document.getElementById("spNext").addEventListener("click", async ()=>{
    // –ø—Ä–æ—Å—Ç–æ –ª–∏—Å—Ç–∞–µ–º, render —Å–∞–º –ø–æ–∫–∞–∂–µ—Ç
    dateState.sp.page += 1;
    renderShortpickTab().catch(console.error);
  });
  document.getElementById("btnExportShortpick").addEventListener("click", async ()=>{
    try{
      const st = dateState.sp;
      const from = toDateOnlyISO(st.from);
      const to = toDateOnlyISO(st.to);
      const data = await apiRecords({ type:TYPES.SHORTPICK, login: st.login||"", from, to, page:1, pageSize:500 });
      const rows = (data.rows||[]).map(r=>({
        Date: r.date,
        "Task order": r.task_order || "",
        SKU: r.sku || "",
        "Box number": r.box_number || "",
        Time: (r.time||"").replace("T"," "),
        Picker: r.person_login || ""
      }));
      if(!rows.length){ toast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞"); return; }
      exportRowsToExcel(rows, "Shortpick", `Shortpick_${from}-${to}.xlsx`);
    }catch(e){ toast("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " + e.message); }
  });

  // AUDIT PICK: search + date + paging + export
  document.getElementById("btnApSearch").addEventListener("click", ()=>{
    dateState.ap.login = document.getElementById("apSearchLogin").value.trim();
    dateState.ap.result = document.getElementById("apResult").value;
    dateState.ap.page = 1;
    renderAuditPickTab().catch(console.error);
  });
  document.getElementById("btnApplyApDate").addEventListener("click", ()=>{
    applyDate("ap");
    dateState.ap.page = 1;
    renderAuditPickTab().catch(console.error);
  });
  document.getElementById("apPrev").addEventListener("click", ()=>{
    dateState.ap.page = Math.max(1, dateState.ap.page-1);
    renderAuditPickTab().catch(console.error);
  });
  document.getElementById("apNext").addEventListener("click", ()=>{
    dateState.ap.page += 1;
    renderAuditPickTab().catch(console.error);
  });
  document.getElementById("btnExportAuditPick").addEventListener("click", async ()=>{
    try{
      const st = dateState.ap;
      const from = toDateOnlyISO(st.from);
      const to = toDateOnlyISO(st.to);
      const data = await apiRecords({
        type:TYPES.AUDIT_PICK,
        login: st.login||"",
        from, to,
        result: st.result||"all",
        page:1, pageSize:500
      });
      const rows = (data.rows||[]).map(r=>({
        Date: r.date,
        Picker: r.person_login || "",
        Container: r.container || "",
        SKU: r.sku || "",
        Audytor: r.auditor || "",
        Result: r.result || ""
      }));
      if(!rows.length){ toast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞"); return; }
      exportRowsToExcel(rows, "Audit pick", `AuditPick_${from}-${to}.xlsx`);
    }catch(e){ toast("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " + e.message); }
  });

  // AUDIT PA: search + date + paging + export
  document.getElementById("btnPaSearch").addEventListener("click", ()=>{
    dateState.pa.login = document.getElementById("paSearchLogin").value.trim();
    dateState.pa.result = document.getElementById("paResult").value;
    dateState.pa.page = 1;
    renderAuditPATab().catch(console.error);
  });
  document.getElementById("btnApplyPaDate").addEventListener("click", ()=>{
    applyDate("pa");
    dateState.pa.page = 1;
    renderAuditPATab().catch(console.error);
  });
  document.getElementById("paPrev").addEventListener("click", ()=>{
    dateState.pa.page = Math.max(1, dateState.pa.page-1);
    renderAuditPATab().catch(console.error);
  });
  document.getElementById("paNext").addEventListener("click", ()=>{
    dateState.pa.page += 1;
    renderAuditPATab().catch(console.error);
  });
  document.getElementById("btnExportAuditPA").addEventListener("click", async ()=>{
    try{
      const st = dateState.pa;
      const from = toDateOnlyISO(st.from);
      const to = toDateOnlyISO(st.to);
      const data = await apiRecords({
        type:TYPES.AUDIT_PA,
        login: st.login||"",
        from, to,
        result: st.result||"all",
        page:1, pageSize:500
      });
      const rows = (data.rows||[]).map(r=>({
        Date: r.date,
        Packer: r.person_login || "",
        Container: r.container || "",
        SKU: r.sku || "",
        Audytor: r.auditor || "",
        Result: r.result || ""
      }));
      if(!rows.length){ toast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞"); return; }
      exportRowsToExcel(rows, "Audit PA", `AuditPA_${from}-${to}.xlsx`);
    }catch(e){ toast("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " + e.message); }
  });

  // IMPORT (admin only) -> server
  document.getElementById("btnAddImport").addEventListener("click", ()=>{
    const me = getMe();
    if(me?.role !== "admin"){ toast("–¢–æ–ª—å–∫–æ admin –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª—ã"); return; }
    document.getElementById("fileInput").click();
  });

  document.getElementById("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    e.target.value = "";
    if(!file) return;

    try{
      const fd = new FormData();
      fd.append("file", file);
      const r = await apiFetch("/api/import", { method:"POST", body: fd });
      toast(`–ò–º–ø–æ—Ä—Ç: ${r.rowsAdded} —Å—Ç—Ä–æ–∫`);

      await renderUserTab();
      await renderShortpickTab();
      await renderAuditPickTab();
      await renderAuditPATab();
      await renderImportsTab();
    }catch(err){
      console.error(err);
      toast("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + err.message);
    }
  });

  // USERS modal
  document.getElementById("btnAddUser").addEventListener("click", ()=> openUserModal({mode:"add"}) );
  document.getElementById("btnUserCancel").addEventListener("click", ()=> document.getElementById("userModal").classList.add("hidden") );
  document.getElementById("btnUserSave").addEventListener("click", saveUserFromModal);

  // delegation (edit/delete users, delete/download imports)
  document.body.addEventListener("click", async (e)=>{
    const a = e.target.closest("[data-action]");
    if(!a) return;
    const action = a.dataset.action;
    const id = a.dataset.id;

    if(action === "editUser"){
      const data = await apiFetch("/api/users");
      const u = (data.rows||[]).find(x=>x.id===id);
      if(u) openUserModal({mode:"edit", user:u});
    }

    if(action === "delUser"){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
      try{
        await apiFetch("/api/users/" + id, { method:"DELETE" });
        toast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω");
        await renderUsersTab();
      }catch(err){
        toast("–û—à–∏–±–∫–∞: " + err.message);
      }
    }

    if(action === "deleteImport"){
      if(!confirm("–£–¥–∞–ª–∏—Ç—å –∏–º–ø–æ—Ä—Ç –∏ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞?")) return;
      try{
        await apiFetch("/api/imports/" + id, { method:"DELETE" });
        toast("–ò–º–ø–æ—Ä—Ç —É–¥–∞–ª—ë–Ω");
        await renderImportsTab();
        await renderUserTab();
      }catch(err){
        toast("–û—à–∏–±–∫–∞: " + err.message);
      }
    }

    if(action === "downloadImport"){
      e.preventDefault();
      try{
        // —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º endpoint
        window.location.href = "/api/imports/" + id + "/file";
      }catch(err){
        toast("–û—à–∏–±–∫–∞: " + err.message);
      }
    }
  });
}

/** =========================================================
 *  APP BOOT
 *  ========================================================= */
function openLogin(){
  document.getElementById("topbar").classList.add("hidden");
  document.getElementById("loginView").classList.remove("hidden");
  document.getElementById("appView").classList.add("hidden");
}
function openApp(){
  document.getElementById("topbar").classList.remove("hidden");
  document.getElementById("loginView").classList.add("hidden");
  document.getElementById("appView").classList.remove("hidden");

  enforceRoleUI();

  renderDateInputs("dateInputs","user");
  renderDateInputs("spDateInputs","sp");
  renderDateInputs("apDateInputs","ap");
  renderDateInputs("paDateInputs","pa");

  applyDate("user");
  applyDate("sp");
  applyDate("ap");
  applyDate("pa");

  setTab("userTab");
}

(async function main(){
  bindTabs();

  bindChooser("userChooser","user","dateInputs");
  bindChooser("spChooser","sp","spDateInputs");
  bindChooser("apChooser","ap","apDateInputs");
  bindChooser("paChooser","pa","paDateInputs");

  bindCoreButtons();

  // –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω ‚Äî –æ—Ç–∫—Ä–æ–µ–º app
  const token = getToken();
  const me = getMe();
  if(token && me){
    try{
      await apiFetch("/api/health");
      openApp();
    }catch{
      clearToken();
      openLogin();
    }
  }else{
    openLogin();
  }
})();
</script>
</body>
</html>

